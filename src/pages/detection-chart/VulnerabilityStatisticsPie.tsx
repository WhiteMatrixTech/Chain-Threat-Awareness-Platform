import { Pie, PieConfig } from '@ant-design/plots';
import cn from 'classnames';
import { useSearchParams } from 'react-router-dom';

import styles from './DetectionChart.module.less';

const VulnerabilityStatisticsPie = () => {
  const [searchParams] = useSearchParams();
  let DetectionResults: any[] = [];
  try {
    DetectionResults = JSON.parse(
      window.atob(searchParams.get('result') || '') || ''
    );
  } catch (e) {}
  const pieConfig = {
    data: [
      {
        type: '低危漏洞',
        value: DetectionResults.filter((o) => o.security !== 'High').length
      },
      {
        type: '高危漏洞',
        value: DetectionResults.filter((o) => o.security === 'High').length
      }
    ],
    height: 200,
    angleField: 'value',
    colorField: 'type',
    color: ['#FE7979', '#FFC4C4'],
    radius: 0.75,
    legend: false, // 关闭图例
    label: {
      type: 'outer',
      content: '{name}',
      style: {
        fill: '#303133'
      }
    },
    interactions: [
      {
        type: 'element-selected'
      },
      {
        type: 'element-active'
      }
    ]
  } as PieConfig;
  return <Pie {...pieConfig} />;
};

export function VulnerabilityStatistics() {
  return (
    <div
      className={cn(
        styles.detectResultCard,
        'h-full flex-col bg-[#FFFAFA] py-[18px] px-6'
      )}
    >
      <div>
        <span className="text-xl font-medium">漏洞等级统计</span>
        <span className="pl-1 text-xl font-normal opacity-70">
          自动形式化验证工具支持
        </span>
      </div>
      <div className="mt-5 h-[80%] w-full flex-1">
        <VulnerabilityStatisticsPie />
      </div>
    </div>
  );
}
